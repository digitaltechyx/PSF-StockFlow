# Testing Auto Invoice Generation Endpoint

## Quick Test Guide

### Step 1: Set Up Environment Variable (Optional for Testing)

If you want to test with security, add to `.env.local`:

```env
INVOICE_CRON_SECRET=test-secret-123
```

**Note**: If `INVOICE_CRON_SECRET` is not set, the endpoint will accept all requests (for testing).

### Step 2: Start Your Dev Server

Make sure your Next.js dev server is running:

```bash
npm run dev
```

Server should be running at: `http://localhost:3000`

### Step 3: Test the Endpoint

#### Option A: Using cURL (Command Line)

**Without Secret** (if INVOICE_CRON_SECRET not set):
```bash
curl -X POST http://localhost:3000/api/invoices/generate-daily
```

**With Secret as URL Parameter**:
```bash
curl -X POST "http://localhost:3000/api/invoices/generate-daily?secret=test-secret-123"
```

**With Secret as Bearer Token**:
```bash
curl -X POST http://localhost:3000/api/invoices/generate-daily \
  -H "Authorization: Bearer test-secret-123"
```

#### Option B: Using Browser (GET request - won't work, but you can see the error)

Open in browser:
```
http://localhost:3000/api/invoices/generate-daily
```

**Note**: This will show an error because it's a POST endpoint, but you can see the endpoint exists.

#### Option C: Using Postman or Thunder Client (VS Code Extension)

1. **Method**: POST
2. **URL**: `http://localhost:3000/api/invoices/generate-daily`
3. **Headers** (if using secret):
   - Key: `Authorization`
   - Value: `Bearer test-secret-123`
4. **OR** add to URL: `?secret=test-secret-123`
5. Click **Send**

#### Option D: Using the Test HTML Page

I've created `test-invoice-endpoint.html` - open it in your browser and click the test button.

### Step 4: Check the Response

**Success Response**:
```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_no_shipments"
    }
  ]
}
```

**Error Response** (Unauthorized):
```json
{
  "error": "Unauthorized"
}
```

**Error Response** (Server Error):
```json
{
  "error": "Auto invoice generation failed",
  "details": "Error message here"
}
```

### Step 5: Verify Invoices Were Created

1. Go to your admin dashboard
2. Navigate to Invoices section
3. Check if new invoices were created for users with shipments today
4. Look for invoices with `autoGenerated: true` flag

## Testing Scenarios

### Scenario 1: Test with Users Who Have Shipments Today

1. Make sure you have users with shipments dated today (New Jersey time)
2. Call the endpoint
3. Should see `invoice_created` status for those users

### Scenario 2: Test Duplicate Prevention

1. Call the endpoint first time - should create invoices
2. Call the endpoint again immediately - should see `skipped_already_generated` for users who got invoices

### Scenario 3: Test with No Shipments

1. Call endpoint when no users have shipments today
2. Should see `skipped_no_shipments` for all users

### Scenario 4: Test Authorization

1. Set `INVOICE_CRON_SECRET=my-secret-123` in `.env.local`
2. Call endpoint without secret - should get `Unauthorized`
3. Call endpoint with correct secret - should work
4. Call endpoint with wrong secret - should get `Unauthorized`

## Troubleshooting

### Error: "Unauthorized"
- Check if `INVOICE_CRON_SECRET` is set
- Make sure you're passing the secret correctly (Bearer token or URL parameter)

### Error: "Auto invoice generation failed"
- Check server logs for detailed error
- Verify Firestore connection
- Check if users collection exists
- Verify shipments data structure

### No Invoices Created
- Check if users have shipments for today (New Jersey timezone)
- Verify shipments have valid data (quantity > 0, unitPrice > 0)
- Check Firestore for any errors

### Empty Results Array
- This is normal if no users have shipments today
- Check the `status` field in results to see why each user was skipped

## Production Testing

Once you've tested locally, test on production:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_PRODUCTION_SECRET"
```

Make sure to use your production `INVOICE_CRON_SECRET` value.




