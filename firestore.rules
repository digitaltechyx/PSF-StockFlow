rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function currentUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdminOrSubAdmin() {
      // Be tolerant to older/dirty data (case/format variations) and feature-based admin access.
      return signedIn() &&
        (
          // Custom claims (if configured)
          (request.auth.token.admin == true) ||
          (request.auth.token.isAdmin == true) ||
          (request.auth.token.sub_admin == true) ||
          (request.auth.token.subAdmin == true) ||
          (request.auth.token.isSubAdmin == true) ||
          ((request.auth.token.role is string) &&
            (
              request.auth.token.role.matches('(?i)^\\s*admin\\s*$') ||
              request.auth.token.role.matches('(?i)^\\s*sub[_\\s-]*admin\\s*$')
            )) ||
          ((request.auth.token.roles is list) &&
            request.auth.token.roles.hasAny(['admin', 'sub_admin', 'sub-admin', 'subadmin', 'Admin', 'SUB_ADMIN', 'ADMIN'])) ||

          // Firestore user doc
          (currentUserDoc().exists &&
          // Explicit booleans used in some installs
          (currentUserDoc().data.isAdmin == true) ||
          (currentUserDoc().data.isSubAdmin == true) ||
          (currentUserDoc().data.admin == true) ||
          (currentUserDoc().data.is_admin == true) ||
          (currentUserDoc().data.is_sub_admin == true) ||

          // Role (single)
          (currentUserDoc().data.role is string &&
            (
              currentUserDoc().data.role.matches('(?i)^\\s*admin\\s*$') ||
              currentUserDoc().data.role.matches('(?i)^\\s*sub[_\\s-]*admin\\s*$')
            )
          ) ||

          // Alternate field names used in some installs
          (currentUserDoc().data.userType is string &&
            (
              currentUserDoc().data.userType.matches('(?i)^\\s*admin\\s*$') ||
              currentUserDoc().data.userType.matches('(?i)^\\s*sub[_\\s-]*admin\\s*$')
            )
          ) ||
          (currentUserDoc().data.userRole is string &&
            (
              currentUserDoc().data.userRole.matches('(?i)^\\s*admin\\s*$') ||
              currentUserDoc().data.userRole.matches('(?i)^\\s*sub[_\\s-]*admin\\s*$')
            )
          ) ||

          // Roles (array)
          (currentUserDoc().data.roles is list &&
            currentUserDoc().data.roles.hasAny([
              'admin',
              'sub_admin',
              'Admin',
              'ADMIN',
              'Sub Admin',
              'SUB_ADMIN',
              'sub admin',
              'sub-admin',
              'subadmin'
            ])) ||

          // Feature-gated admin UI accounts (some installs use features instead of role)
          // features as array
          (currentUserDoc().data.features is list &&
            currentUserDoc().data.features.hasAny([
              'admin_dashboard',
              'manage_users',
              'manage_invoices',
              'manage_labels'
            ])) ||
          // features as map { admin_dashboard: true, ... }
          (currentUserDoc().data.features is map &&
            (
              currentUserDoc().data.features.admin_dashboard == true ||
              currentUserDoc().data.features.manage_users == true ||
              currentUserDoc().data.features.manage_invoices == true ||
              currentUserDoc().data.features.manage_labels == true
            )))
        );
    }

    function isCommissionAgent() {
      return signedIn() &&
        currentUserDoc().exists &&
        (
          currentUserDoc().data.role == 'commission_agent' ||
          (currentUserDoc().data.roles != null &&
            currentUserDoc().data.roles.hasAny(['commission_agent']))
        );
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isSelfOrAdmin(userId) {
      return isSelf(userId) || isAdminOrSubAdmin();
    }

    // ---- USERS (profiles) ----
    match /users/{userId} {
      // Users: read/update their own profile.
      // Admin/sub_admin: read/update any profile.
      allow get, update: if isSelfOrAdmin(userId);

      // Create own profile during registration.
      allow create: if isSelf(userId);

      // Delete user profile only for admin/sub_admin.
      allow delete: if isAdminOrSubAdmin();

      // Referral-code validation during registration (unauthenticated).
      // NOTE: This is intentionally permissive for list to support referral lookup.
      // Consider moving referral codes to a dedicated collection later for tighter security.
      allow list: if request.auth == null;

      // Authenticated listing is allowed (client will filter based on role/features).
      allow list: if signedIn();
    }

    // ---- ALL USER SUBCOLLECTIONS (inventory, invoices, requests, logs, pricing, etc.) ----
    match /users/{userId}/{document=**} {
      allow read, write: if isSelfOrAdmin(userId);
    }

    // ---- UPLOADED PDFs ----
    match /uploadedPDFs/{pdfId} {
      allow read: if signedIn() && (resource.data.uploadedBy == request.auth.uid || isAdminOrSubAdmin());
      allow create: if signedIn() && request.resource.data.uploadedBy == request.auth.uid;
      allow update, delete: if signedIn() && (resource.data.uploadedBy == request.auth.uid || isAdminOrSubAdmin());
      allow list: if signedIn();
    }

    // ---- COMMISSIONS ----
    match /commissions/{commissionId} {
      // Admin/sub_admin can manage all.
      allow read, write: if isAdminOrSubAdmin();

      // Commission agent can read their own commission docs.
      allow get: if signedIn() && resource.data.agentId == request.auth.uid;
      allow list: if isCommissionAgent();
    }

    // ---- ADMIN OVERRIDE ----
    // Ensures admin/sub_admin never sees "Missing or insufficient permissions"
    // for top-level admin-managed collections not explicitly listed above.
    match /{document=**} {
      allow read, write: if isAdminOrSubAdmin();
    }
  }
}


