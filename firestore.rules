rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function currentUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdminOrSubAdmin() {
      // Be tolerant to older/dirty data (case/format variations) and feature-based admin access.
      return signedIn() &&
        currentUserDoc().exists &&
        (
          // Role (single)
          currentUserDoc().data.role == 'admin' ||
          currentUserDoc().data.role == 'sub_admin' ||
          currentUserDoc().data.role == 'Admin' ||
          currentUserDoc().data.role == 'Sub Admin' ||
          currentUserDoc().data.role == 'sub-admin' ||
          currentUserDoc().data.role == 'subadmin' ||

          // Roles (array)
          (currentUserDoc().data.roles != null &&
            currentUserDoc().data.roles.hasAny([
              'admin',
              'sub_admin',
              'Admin',
              'Sub Admin',
              'sub-admin',
              'subadmin'
            ])) ||

          // Feature-gated admin UI accounts (some installs use features instead of role)
          (currentUserDoc().data.features != null &&
            currentUserDoc().data.features.hasAny([
              'admin_dashboard',
              'manage_users',
              'manage_invoices',
              'manage_labels'
            ]))
        );
    }

    function isCommissionAgent() {
      return signedIn() &&
        currentUserDoc().exists &&
        (
          currentUserDoc().data.role == 'commission_agent' ||
          (currentUserDoc().data.roles != null &&
            currentUserDoc().data.roles.hasAny(['commission_agent']))
        );
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isSelfOrAdmin(userId) {
      return isSelf(userId) || isAdminOrSubAdmin();
    }

    // ---- USERS (profiles) ----
    match /users/{userId} {
      // Users: read/update their own profile.
      // Admin/sub_admin: read/update any profile.
      allow get, update: if isSelfOrAdmin(userId);

      // Create own profile during registration.
      allow create: if isSelf(userId);

      // Delete user profile only for admin/sub_admin.
      allow delete: if isAdminOrSubAdmin();

      // Referral-code validation during registration (unauthenticated).
      // NOTE: This is intentionally permissive for list to support referral lookup.
      // Consider moving referral codes to a dedicated collection later for tighter security.
      allow list: if request.auth == null;

      // Authenticated listing is allowed (client will filter based on role/features).
      allow list: if signedIn();
    }

    // ---- ALL USER SUBCOLLECTIONS (inventory, invoices, requests, logs, pricing, etc.) ----
    match /users/{userId}/{document=**} {
      allow read, write: if isSelfOrAdmin(userId);
    }

    // ---- UPLOADED PDFs ----
    match /uploadedPDFs/{pdfId} {
      allow read: if signedIn() && (resource.data.uploadedBy == request.auth.uid || isAdminOrSubAdmin());
      allow create: if signedIn() && request.resource.data.uploadedBy == request.auth.uid;
      allow update, delete: if signedIn() && (resource.data.uploadedBy == request.auth.uid || isAdminOrSubAdmin());
      allow list: if signedIn();
    }

    // ---- COMMISSIONS ----
    match /commissions/{commissionId} {
      // Admin/sub_admin can manage all.
      allow read, write: if isAdminOrSubAdmin();

      // Commission agent can read their own commission docs.
      allow get: if signedIn() && resource.data.agentId == request.auth.uid;
      allow list: if isCommissionAgent();
    }

    // ---- ADMIN OVERRIDE ----
    // Ensures admin/sub_admin never sees "Missing or insufficient permissions"
    // for top-level admin-managed collections not explicitly listed above.
    match /{document=**} {
      allow read, write: if isAdminOrSubAdmin();
    }
  }
}


