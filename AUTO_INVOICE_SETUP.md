# Auto Invoice Generation Setup Guide

## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)


## Overview

The auto invoicing feature generates invoices daily at **1:00 PM New Jersey Time** for all users who have shipments on the current day.

## API Endpoint

**Endpoint**: `POST /api/invoices/generate-daily`

**URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`

## How It Works

1. **Runs Daily at 1:00 PM New Jersey Time**
   - Generates invoices for the current day (New Jersey timezone)
   - Processes all users who have shipments on that day
   - Skips users who already have an invoice for that date

2. **Invoice Generation Logic**
   - Finds all shipments for the current day (New Jersey timezone)
   - Groups shipments by user
   - Creates invoice items from shipments
   - Generates invoice number and order number
   - Saves invoice with status "pending"

3. **Duplicate Prevention**
   - Checks if invoice already exists for the date (`autoGeneratedForDate`)
   - Skips generation if invoice already exists

## Setting Up Cron Job

You need to set up a cron job to call this endpoint daily at 1:00 PM New Jersey Time.

### Option 1: Vercel Cron Jobs (Recommended)

If you're using Vercel, the `vercel.json` file is already configured:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

**Schedule Details**:
- **Cron Schedule**: `0 18 * * *` (runs at 6:00 PM UTC daily)
- **New Jersey Time**: 
  - **EST (Winter)**: 1:00 PM ✅ (6 PM UTC = 1 PM EST)
  - **EDT (Summer)**: 2:00 PM ⚠️ (6 PM UTC = 2 PM EDT)

**Note**: Vercel cron runs in UTC. The current schedule (`0 18 * * *`) will run at:
- **1:00 PM EST** (winter months)
- **2:00 PM EDT** (summer months)

If you need it to run exactly at 1:00 PM year-round, you'll need to adjust the schedule twice a year, or use an external cron service that supports timezones.

### Option 2: External Cron Service (Recommended for Timezone Accuracy)

Use services like:
- **Cron-job.org** (Free)
- **EasyCron** (Free tier available)
- **cron-job.com** (Free)

**Setup Steps**:

1. **Create Account** on cron service
2. **Add New Cron Job**:
   - **URL**: `https://ims.prepservicesfba.com/api/invoices/generate-daily`
   - **Method**: POST
   - **Schedule**: Daily at 1:00 PM (select New Jersey/Eastern timezone)
   - **Headers**: 
     - `Authorization: Bearer YOUR_CRON_SECRET` (if using secret)
     - OR add `?secret=YOUR_CRON_SECRET` to URL
3. **Save Cron Job**

### Option 3: Server Cron (If self-hosting)

Add to your server's crontab:

```bash
# Run daily at 1:00 PM New Jersey Time (6:00 PM UTC in winter, 5:00 PM UTC in summer)
0 18 * * * curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

## Security

The endpoint is protected by `INVOICE_CRON_SECRET` environment variable.

**Setup**:
1. Generate a secure random string
2. Add to environment variables: `INVOICE_CRON_SECRET=your-secret-here`
3. Use this secret in your cron job:
   - As Bearer token: `Authorization: Bearer your-secret-here`
   - OR as URL parameter: `?secret=your-secret-here`

## Environment Variables

Add to your `.env` or hosting platform:

```env
INVOICE_CRON_SECRET=your-secure-random-string-here
```

## Testing

### Manual Test

You can manually trigger the endpoint:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily?secret=YOUR_CRON_SECRET"
```

Or using the Authorization header:

```bash
curl -X POST "https://ims.prepservicesfba.com/api/invoices/generate-daily" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

### Expected Response

```json
{
  "success": true,
  "invoiceDate": "2024-01-15",
  "windowStart": "2024-01-15T05:00:00.000Z",
  "windowEnd": "2024-01-16T04:59:59.999Z",
  "results": [
    {
      "userId": "user123",
      "status": "invoice_created",
      "invoiceNumber": "INV-2024-001",
      "shipmentsProcessed": 5,
      "total": 150.00
    },
    {
      "userId": "user456",
      "status": "skipped_already_generated"
    }
  ]
}
```

## Response Statuses

- `invoice_created` - Invoice successfully created
- `skipped_already_generated` - Invoice already exists for this date
- `skipped_no_shipments` - No shipments found for this date
- `skipped_no_billable_items` - Shipments found but no billable items
- `skipped_zero_total` - Items found but total is zero

## Troubleshooting

### Invoices Not Generating

1. **Check Cron Job Status**
   - Verify cron job is running
   - Check cron job logs for errors

2. **Check API Response**
   - Manually call the endpoint
   - Check response for errors

3. **Check Environment Variables**
   - Ensure `INVOICE_CRON_SECRET` is set
   - Verify secret matches in cron job

4. **Check Firestore**
   - Verify shipments exist for the date
   - Check if invoices already exist (duplicate prevention)

5. **Check Timezone**
   - Ensure cron job runs at correct time
   - Verify New Jersey timezone calculations

## Current Implementation Details

- **Timezone**: New Jersey (America/New_York)
- **Time**: 1:00 PM daily
- **Date Range**: Current day (00:00:00 to 23:59:59 New Jersey time)
- **Invoice Status**: "pending"
- **Auto-generated Flag**: `autoGenerated: true`
- **Date Tracking**: `autoGeneratedForDate` field prevents duplicates

## Notes

- Invoices are generated for the **current day** in New Jersey timezone
- Each user gets **one invoice per day** (duplicate prevention)
- Only users with shipments on that day get invoices
- Invoices are created with status "pending" (admin can mark as paid later)

