<!-- PSF Shipping Cost Calculator - Standalone HTML Version -->
<!-- Copy this entire code block into a WordPress Custom HTML Widget or Page -->

<div id="psf-shipping-calculator-standalone">
  <style>
    /**
     * PSF Shipping Calculator Styles - Simple Interface
     */
    #psf-shipping-calculator-standalone {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .psf-calc-container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    .psf-calc-form {
      margin-bottom: 30px;
    }

    .psf-form-group {
      margin-bottom: 20px;
    }

    .psf-form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }

    .psf-form-group input,
    .psf-form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    .psf-form-group input:focus,
    .psf-form-group select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .psf-form-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
    }

    .psf-form-row .psf-form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .psf-dimensions-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .psf-dimensions-row .psf-form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .psf-dimensions-row .psf-form-group:last-child {
      flex: 0 0 120px;
    }

    .psf-weight-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .psf-weight-row .psf-form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .psf-weight-row .psf-form-group:last-child {
      flex: 0 0 100px;
    }

    .psf-calc-submit {
      text-align: center;
      margin-top: 30px;
    }

    .psf-calc-btn {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      border: none;
      padding: 14px 40px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 200px;
    }

    .psf-calc-btn:hover {
      background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .psf-calc-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .psf-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: psf-spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes psf-spin {
      to { transform: rotate(360deg); }
    }

    /* Results Section */
    .psf-calc-results {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #e5e5e5;
    }

    .psf-results-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }

    .psf-calc-error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    /* Rates Table */
    .psf-rates-table-wrapper {
      overflow-x: auto;
    }

    .psf-rates-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .psf-rates-table thead {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
    }

    .psf-rates-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .psf-rates-table td {
      padding: 15px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 14px;
    }

    .psf-rates-table tbody tr:hover {
      background: #f8f9fa;
    }

    .psf-rates-table tbody tr:last-child td {
      border-bottom: none;
    }

    .psf-carrier-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #333;
    }

    .psf-carrier-name {
      font-size: 16px;
    }

    .psf-service-name {
      color: #666;
      font-size: 14px;
    }

    .psf-rate-price {
      font-size: 20px;
      font-weight: 700;
      color: #007bff;
    }

    .psf-rate-currency {
      font-size: 14px;
      color: #999;
      margin-left: 2px;
    }

    .psf-delivery-days {
      color: #28a745;
      font-weight: 500;
    }

    .psf-delivery-days::after {
      content: " days";
      font-size: 12px;
      color: #999;
    }

    .psf-best-rate {
      background: #e7f5e7 !important;
      border-left: 4px solid #28a745;
    }

    .psf-best-rate-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 12px;
      text-transform: uppercase;
      margin-left: 8px;
    }

    /* Responsive Design - Tablet */
    @media (max-width: 1024px) {
      #psf-shipping-calculator-standalone {
        max-width: 100%;
        padding: 15px;
      }
      
      .psf-calc-container {
        padding: 25px;
      }
      
      .psf-results-title {
        font-size: 20px;
      }
    }

    /* Responsive Design - Mobile & Small Tablets */
    @media (max-width: 768px) {
      #psf-shipping-calculator-standalone {
        padding: 10px;
      }
      
      .psf-calc-container {
        padding: 20px 15px;
        border-radius: 8px;
      }
      
      .psf-form-group {
        margin-bottom: 18px;
      }
      
      .psf-form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .psf-form-group input,
      .psf-form-group select {
        padding: 12px;
        font-size: 16px; /* Prevents zoom on iOS */
        border-radius: 8px;
      }
      
      /* Dimensions Row - Keep horizontal on mobile */
      .psf-dimensions-row {
        flex-direction: row;
        gap: 8px;
        flex-wrap: nowrap;
      }
      
      .psf-dimensions-row .psf-form-group {
        flex: 1;
        margin-bottom: 0;
        min-width: 0; /* Allow flex items to shrink */
      }
      
      .psf-dimensions-row .psf-form-group input {
        padding: 10px 8px;
        font-size: 14px;
        text-align: center;
      }
      
      .psf-dimensions-row .psf-form-group:last-child {
        flex: 0 0 90px;
        min-width: 90px;
      }
      
      .psf-dimensions-row .psf-form-group:last-child select {
        padding: 10px 6px;
        font-size: 13px;
      }
      
      /* Weight Row - Keep horizontal on mobile */
      .psf-weight-row {
        flex-direction: row;
        gap: 8px;
        flex-wrap: nowrap;
      }
      
      .psf-weight-row .psf-form-group {
        flex: 1;
        margin-bottom: 0;
        min-width: 0;
      }
      
      .psf-weight-row .psf-form-group input {
        padding: 10px 8px;
        font-size: 14px;
      }
      
      .psf-weight-row .psf-form-group:last-child {
        flex: 0 0 80px;
        min-width: 80px;
      }
      
      .psf-weight-row .psf-form-group:last-child select {
        padding: 10px 6px;
        font-size: 13px;
      }
      
      .psf-calc-submit {
        margin-top: 25px;
      }
      
      .psf-calc-btn {
        width: 100%;
        padding: 14px 20px;
        font-size: 16px;
        min-width: auto;
      }
      
      .psf-results-title {
        font-size: 18px;
        margin-bottom: 15px;
      }
      
      .psf-calc-results {
        margin-top: 30px;
        padding-top: 20px;
      }
      
      /* Rates Table - Mobile Optimized */
      .psf-rates-table-wrapper {
        -webkit-overflow-scrolling: touch;
        margin: 0 -15px;
        padding: 0 15px;
      }
      
      .psf-rates-table {
        font-size: 12px;
        min-width: 600px; /* Minimum width for horizontal scroll */
      }
      
      .psf-rates-table th {
        padding: 12px 8px;
        font-size: 11px;
        white-space: nowrap;
      }
      
      .psf-rates-table td {
        padding: 12px 8px;
        font-size: 12px;
      }
      
      .psf-carrier-logo {
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .psf-carrier-name {
        font-size: 14px;
      }
      
      .psf-service-name {
        font-size: 12px;
      }
      
      .psf-rate-price {
        font-size: 18px;
      }
      
      .psf-best-rate-badge {
        font-size: 9px;
        padding: 2px 6px;
        margin-left: 4px;
      }
    }

    /* Responsive Design - Small Mobile */
    @media (max-width: 480px) {
      #psf-shipping-calculator-standalone {
        padding: 8px;
      }
      
      .psf-calc-container {
        padding: 15px 12px;
      }
      
      .psf-form-group {
        margin-bottom: 16px;
      }
      
      .psf-form-group label {
        font-size: 12px;
        margin-bottom: 5px;
      }
      
      .psf-form-group input,
      .psf-form-group select {
        padding: 11px;
        font-size: 16px;
      }
      
      .psf-dimensions-row,
      .psf-weight-row {
        gap: 6px;
      }
      
      .psf-dimensions-row .psf-form-group:last-child {
        flex: 0 0 85px;
        min-width: 85px;
      }
      
      .psf-weight-row .psf-form-group:last-child {
        flex: 0 0 75px;
        min-width: 75px;
      }
      
      .psf-dimensions-row .psf-form-group input,
      .psf-weight-row .psf-form-group input {
        padding: 10px 6px;
        font-size: 14px;
      }
      
      .psf-dimensions-row .psf-form-group:last-child select,
      .psf-weight-row .psf-form-group:last-child select {
        padding: 10px 4px;
        font-size: 12px;
      }
      
      .psf-calc-btn {
        padding: 13px 18px;
        font-size: 15px;
      }
      
      .psf-results-title {
        font-size: 16px;
      }
      
      .psf-rates-table {
        font-size: 11px;
        min-width: 550px;
      }
      
      .psf-rates-table th {
        padding: 10px 6px;
        font-size: 10px;
      }
      
      .psf-rates-table td {
        padding: 10px 6px;
        font-size: 11px;
      }
      
      .psf-rate-price {
        font-size: 16px;
      }
      
      .psf-carrier-name {
        font-size: 13px;
      }
    }

    /* Landscape Mobile */
    @media (max-width: 768px) and (orientation: landscape) {
      .psf-dimensions-row {
        gap: 10px;
      }
      
      .psf-dimensions-row .psf-form-group:last-child {
        flex: 0 0 110px;
        min-width: 110px;
      }
      
      .psf-weight-row {
        gap: 10px;
      }
      
      .psf-weight-row .psf-form-group:last-child {
        flex: 0 0 90px;
        min-width: 90px;
      }
    }
  </style>

  <div class="psf-calc-container">
    <form id="psf-shipping-calc-form" class="psf-calc-form">
      <!-- Warehouse Selection -->
      <div class="psf-form-group">
        <label for="warehouse">Select Warehouse</label>
        <select id="warehouse" name="warehouse" required>
          <option value="mount-laurel">ðŸ‡ºðŸ‡¸ Mount Laurel, United States (08054)</option>
        </select>
      </div>

      <!-- Destination Zip Code -->
      <div class="psf-form-group">
        <label for="destination-zip">Destination Zip Code</label>
        <input type="text" id="destination-zip" name="destinationZip" placeholder="Zipcode" required pattern="[0-9]{5}(-[0-9]{4})?" maxlength="10">
      </div>

      <!-- Dimensions -->
      <div class="psf-form-group">
        <label for="dimensions">Dimensions</label>
        <div class="psf-dimensions-row">
          <div class="psf-form-group">
            <input type="number" id="parcel-length" name="parcelLength" placeholder="L" step="0.01" min="0.01" required>
          </div>
          <div class="psf-form-group">
            <input type="number" id="parcel-width" name="parcelWidth" placeholder="W" step="0.01" min="0.01" required>
          </div>
          <div class="psf-form-group">
            <input type="number" id="parcel-height" name="parcelHeight" placeholder="H" step="0.01" min="0.01" required>
          </div>
          <div class="psf-form-group">
            <select id="dimension-unit" name="dimensionUnit">
              <option value="in" selected>Inches</option>
              <option value="cm">Centimeters</option>
              <option value="ft">Feet</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Weight -->
      <div class="psf-form-group">
        <label for="weight">Weight</label>
        <div class="psf-weight-row">
          <div class="psf-form-group">
            <input type="number" id="parcel-weight" name="parcelWeight" placeholder="0.00" step="0.01" min="0.01" required>
          </div>
          <div class="psf-form-group">
            <select id="weight-unit" name="weightUnit">
              <option value="lb" selected>lbs</option>
              <option value="oz">oz</option>
              <option value="kg">kg</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="psf-calc-submit">
        <button type="submit" id="psf-calc-submit-btn" class="psf-calc-btn">
          <span class="psf-btn-text">Get Shipping Rates</span>
          <span class="psf-btn-loader" style="display: none;">
            <span class="psf-spinner"></span> Calculating...
          </span>
        </button>
      </div>
    </form>

    <!-- Results Section -->
    <div id="psf-calc-results" class="psf-calc-results" style="display: none;">
      <h3 class="psf-results-title">Available Shipping Rates</h3>
      <div id="psf-calc-error" class="psf-calc-error" style="display: none;"></div>
      <div id="psf-rates-table-wrapper" class="psf-rates-table-wrapper"></div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // Warehouse data mapping
      const warehouses = {
        'mount-laurel': {
          name: 'Mount Laurel',
          street1: '7000 Atrium Way B05',
          city: 'Mount Laurel',
          state: 'NJ',
          zip: '08054',
          country: 'US'
        }
      };

      // Carrier logo mapping
      const carrierLogos = {
        'usps': 'ðŸ“®',
        'ups': 'ðŸšš',
        'fedex': 'ðŸ“¦',
        'dhl': 'âœˆï¸',
        'dhl_express': 'âœˆï¸'
      };

      // Carrier display names
      const carrierNames = {
        'usps': 'USPS',
        'ups': 'UPS',
        'fedex': 'FedEx',
        'dhl': 'DHL',
        'dhl_express': 'DHL Express'
      };

      // API endpoint
      const API_URL = 'https://ims.prepservicesfba.com/api/shippo/rates';
      
      // Debug: Log current origin
      console.log('Current origin:', window.location.origin);

      // Get DOM elements
      const form = document.getElementById('psf-shipping-calc-form');
      const submitBtn = document.getElementById('psf-calc-submit-btn');
      const results = document.getElementById('psf-calc-results');
      const errorDiv = document.getElementById('psf-calc-error');
      const ratesWrapper = document.getElementById('psf-rates-table-wrapper');

      // Form submit handler
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        calculateShipping().catch(error => {
          setLoadingState(false);
          showError('An error occurred. Please try again.');
          console.error('Error:', error);
        });
      });

      // Lookup city and state from zip code
      async function lookupZipCode(zipCode) {
        try {
          const response = await fetch(`https://api.zippopotam.us/us/${zipCode}`);
          if (!response.ok) {
            throw new Error('Zip code not found');
          }
          const data = await response.json();
          if (data.places && data.places.length > 0) {
            return {
              city: data.places[0]['place name'],
              state: data.places[0]['state abbreviation']
            };
          }
          throw new Error('No location data found');
        } catch (error) {
          console.error('Zip code lookup error:', error);
          // Fallback: return null and we'll use a generic address
          return null;
        }
      }

      async function calculateShipping() {
        // Validate form
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // Get form values
        const warehouseId = document.getElementById('warehouse').value;
        const destinationZip = document.getElementById('destination-zip').value.replace(/\D/g, ''); // Remove non-digits
        
        // Validate zip code
        if (destinationZip.length < 5) {
          showError('Please enter a valid 5-digit zip code.');
          return;
        }
        
        const length = parseFloat(document.getElementById('parcel-length').value);
        const width = parseFloat(document.getElementById('parcel-width').value);
        const height = parseFloat(document.getElementById('parcel-height').value);
        const dimensionUnit = document.getElementById('dimension-unit').value;
        const weight = parseFloat(document.getElementById('parcel-weight').value);
        const weightUnit = document.getElementById('weight-unit').value;

        // Get warehouse data
        const warehouse = warehouses[warehouseId];
        if (!warehouse) {
          showError('Invalid warehouse selected.');
          return;
        }

        // Convert dimensions to inches if needed
        let lengthIn = length;
        let widthIn = width;
        let heightIn = height;
        
        if (dimensionUnit === 'cm') {
          lengthIn = length / 2.54;
          widthIn = width / 2.54;
          heightIn = height / 2.54;
        } else if (dimensionUnit === 'ft') {
          lengthIn = length * 12;
          widthIn = width * 12;
          heightIn = height * 12;
        }

        // Convert weight to pounds if needed
        let weightLb = weight;
        if (weightUnit === 'oz') {
          weightLb = weight / 16;
        } else if (weightUnit === 'kg') {
          weightLb = weight * 2.20462;
        }

        // Show loading state
        setLoadingState(true);
        errorDiv.style.display = 'none';
        results.style.display = 'none';

        // Lookup zip code to get city and state
        let destinationCity = 'City';
        let destinationState = 'ST';
        
        try {
          const zipData = await lookupZipCode(destinationZip);
          if (zipData) {
            destinationCity = zipData.city;
            destinationState = zipData.state;
          }
        } catch (error) {
          console.warn('Using fallback address for zip code');
        }

        // Prepare API request data
        const formData = {
          fromAddress: {
            name: warehouse.name + ' Warehouse',
            street1: warehouse.street1,
            street2: '',
            city: warehouse.city,
            state: warehouse.state,
            zip: warehouse.zip,
            country: warehouse.country,
            phone: '',
            email: ''
          },
          toAddress: {
            name: 'Recipient',
            street1: '1 Main Street', // Generic but valid street address
            street2: '',
            city: destinationCity,
            state: destinationState,
            zip: destinationZip,
            country: 'US',
            phone: '',
            email: ''
          },
          parcel: {
            length: lengthIn,
            width: widthIn,
            height: heightIn,
            weight: weightLb,
            distanceUnit: 'in',
            weightUnit: 'lb'
          }
        };

        // Make API call
        fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
          mode: 'cors' // Explicitly set CORS mode
        })
        .then(async response => {
          // Check if response is ok before trying to parse JSON
          if (!response.ok) {
            let errorText = 'Failed to get shipping rates';
            try {
              const errorData = await response.json();
              errorText = errorData.error || errorData.details || errorText;
            } catch (e) {
              errorText = `Server error: ${response.status} ${response.statusText}`;
            }
            throw new Error(errorText);
          }
          
          const data = await response.json();
          return data;
        })
        .then(data => {
          setLoadingState(false);
          if (data.error) {
            showError(data.error + (data.details ? ': ' + data.details : ''));
          } else if (data.rates && data.rates.length > 0) {
            displayRates(data.rates);
          } else {
            showError('No shipping rates available for this shipment.');
          }
        })
        .catch(error => {
          setLoadingState(false);
          let errorMessage = 'Failed to get shipping rates. ';
          
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += 'Network error - please check your connection and ensure the API is accessible.';
          } else if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
            errorMessage += 'CORS error - the API may not be configured to allow requests from this domain.';
          } else {
            errorMessage += error.message || 'Please try again.';
          }
          
          showError(errorMessage);
          console.error('Full error:', error);
          console.error('API URL:', API_URL);
          console.error('Request data:', formData);
        });
      }

      function setLoadingState(loading) {
        const btnText = submitBtn.querySelector('.psf-btn-text');
        const btnLoader = submitBtn.querySelector('.psf-btn-loader');
        
        if (loading) {
          submitBtn.disabled = true;
          btnText.style.display = 'none';
          btnLoader.style.display = 'inline';
        } else {
          submitBtn.disabled = false;
          btnText.style.display = 'inline';
          btnLoader.style.display = 'none';
        }
      }

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        results.style.display = 'block';
      }

      function displayRates(rates) {
        // Sort rates by price (lowest first)
        rates.sort((a, b) => parseFloat(a.amount) - parseFloat(b.amount));
        
        // Find best rate (lowest price)
        const bestPrice = parseFloat(rates[0].amount);

        // Build table HTML
        let tableHTML = '<table class="psf-rates-table">';
        tableHTML += '<thead><tr>';
        tableHTML += '<th>Carrier</th>';
        tableHTML += '<th>Service</th>';
        tableHTML += '<th>Price</th>';
        tableHTML += '<th>Delivery Time</th>';
        tableHTML += '</tr></thead>';
        tableHTML += '<tbody>';

        rates.forEach(function(rate) {
          const isBestRate = parseFloat(rate.amount) === bestPrice;
          const rowClass = isBestRate ? 'psf-best-rate' : '';
          
          const carrier = rate.provider.toLowerCase();
          const carrierLogo = carrierLogos[carrier] || 'ðŸ“¦';
          const carrierName = carrierNames[carrier] || rate.provider;
          const serviceName = rate.servicelevel?.name || 'Standard';
          const price = parseFloat(rate.amount).toFixed(2);
          const currency = rate.currency || 'USD';
          const deliveryDays = rate.estimated_days ? rate.estimated_days : 'N/A';

          tableHTML += '<tr class="' + rowClass + '">';
          tableHTML += '<td><div class="psf-carrier-logo">';
          tableHTML += '<span class="psf-carrier-icon">' + carrierLogo + '</span>';
          tableHTML += '<span class="psf-carrier-name">' + carrierName + '</span>';
          if (isBestRate) {
            tableHTML += '<span class="psf-best-rate-badge">Best Rate</span>';
          }
          tableHTML += '</div></td>';
          tableHTML += '<td><span class="psf-service-name">' + escapeHtml(serviceName) + '</span></td>';
          tableHTML += '<td><span class="psf-rate-price">$' + price + '</span>';
          tableHTML += '<span class="psf-rate-currency">' + currency + '</span></td>';
          tableHTML += '<td>';
          if (deliveryDays !== 'N/A') {
            tableHTML += '<span class="psf-delivery-days">' + deliveryDays + '</span>';
          } else {
            tableHTML += '<span style="color: #999;">N/A</span>';
          }
          tableHTML += '</td>';
          tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        
        ratesWrapper.innerHTML = tableHTML;
        results.style.display = 'block';
        
        // Scroll to results
        results.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      // Format zip code input (add dash for ZIP+4)
      document.getElementById('destination-zip').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
          value = value.substring(0, 5) + '-' + value.substring(5, 9);
        }
        e.target.value = value;
      });
    })();
  </script>
</div>
