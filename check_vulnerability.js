const fs = require('fs');
const packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
const lockfile = JSON.parse(fs.readFileSync('./package-lock.json', 'utf8'));

console.log('=== VULNERABILITY CHECK ===\n');

// Check Next.js version
const nextVersion = packageJson.dependencies.next;
console.log(`Next.js version in package.json: ${nextVersion}`);

// Find the actual installed version
const nextKey = Object.keys(lockfile.packages).find(k => k === 'node_modules/next');
if (nextKey) {
  const installedVersion = lockfile.packages[nextKey].version;
  console.log(`Next.js version installed: ${installedVersion}`);
  
  // Check if it's patched
  const [major, minor, patch] = installedVersion.split('.').map(Number);
  
  if (major === 15 && minor === 3 && patch >= 6) {
    console.log(`✅ SAFE: Next.js 15.3.x is patched at version ${installedVersion}`);
  } else if (major === 15 && minor < 3) {
    console.log(`⚠️  NEEDS UPDATE: Next.js ${major}.${minor}.${patch} is vulnerable`);
  } else if (major === 16 && patch >= 7) {
    console.log(`✅ SAFE: Next.js 16.x is patched at version ${installedVersion}`);
  } else {
    console.log(`❓ Unknown status for version ${installedVersion}`);
  }
}

// Check for React Flight packages
const flightPackages = ['react-server-dom-webpack', 'react-server-dom-parcel', 'react-server-dom-turbopack'];
const hasFlightPackages = flightPackages.some(pkg => packageJson.dependencies[pkg]);

console.log(`\nReact Flight packages found: ${hasFlightPackages ? 'YES - VULNERABLE' : 'NO - SAFE'}`);

console.log('\n=== CONCLUSION ===');
if (!hasFlightPackages && nextVersion === '15.3.6') {
  console.log('✅ Project is PATCHED against the React Flight RCE vulnerability');
  console.log('   - Next.js is at the patched version (15.3.6)');
  console.log('   - No React Flight packages are used');
} else {
  console.log('⚠️  Further investigation needed');
}
