# Vercel Cron Job Setup Guide

## ✅ Quick Setup (Already Done!)

The `vercel.json` file is already configured with the cron job. You just need to:

1. **Deploy to Vercel** (if not already deployed)
2. **Add Environment Variable** (if using security)
3. **Verify Cron Job** in Vercel Dashboard

## Step-by-Step Setup

### Step 1: Verify vercel.json

Make sure `vercel.json` exists in your project root with:

```json
{
  "crons": [
    {
      "path": "/api/invoices/generate-daily",
      "schedule": "0 18 * * *"
    }
  ]
}
```

✅ **Already created!** You can skip this step.

### Step 2: Add Environment Variable (Optional but Recommended)

1. Go to **Vercel Dashboard** → Your Project
2. Navigate to **Settings** → **Environment Variables**
3. Add new variable:
   - **Name**: `INVOICE_CRON_SECRET`
   - **Value**: Generate a secure random string (e.g., use a password generator)
   - **Environment**: Production (and Preview if you want)
4. Click **Save**

**Example secret**: `invoice-cron-secret-2024-abc123xyz789`

### Step 3: Deploy to Vercel

If you haven't deployed yet:

```bash
# Install Vercel CLI (if not installed)
npm i -g vercel

# Deploy
vercel --prod
```

Or push to your Git repository (if connected to Vercel, it will auto-deploy).

### Step 4: Verify Cron Job

1. Go to **Vercel Dashboard** → Your Project
2. Navigate to **Settings** → **Cron Jobs**
3. You should see:
   - **Path**: `/api/invoices/generate-daily`
   - **Schedule**: `0 18 * * *` (Daily at 6:00 PM UTC)
   - **Status**: Active

### Step 5: Test the Cron Job

You can manually trigger it from Vercel Dashboard:

1. Go to **Vercel Dashboard** → Your Project
2. Navigate to **Settings** → **Cron Jobs**
3. Click on the cron job
4. Click **"Run Now"** or **"Trigger"** button
5. Check the logs to see if it ran successfully

## Schedule Explanation

**Current Schedule**: `0 18 * * *`

- **Format**: `minute hour day month weekday`
- **Meaning**: Every day at 18:00 UTC (6:00 PM UTC)
- **New Jersey Time**:
  - **EST (Nov-Mar)**: 1:00 PM ✅
  - **EDT (Mar-Nov)**: 2:00 PM ⚠️

## Adjusting the Schedule

If you want it to run at exactly 1:00 PM New Jersey time year-round, you have two options:

### Option A: Use 5 PM UTC (1 PM EDT)

Change schedule to: `"0 17 * * *"`
- **EST**: 12:00 PM (noon)
- **EDT**: 1:00 PM ✅

### Option B: Use 6 PM UTC (1 PM EST) - Current

Keep: `"0 18 * * *"`
- **EST**: 1:00 PM ✅
- **EDT**: 2:00 PM

**Recommendation**: Keep `0 18 * * *` (current) - it's closer to 1 PM for most of the year.

## Security Setup

### Without Secret (Testing Only)

If `INVOICE_CRON_SECRET` is not set, the endpoint accepts all requests. This is fine for testing but **NOT recommended for production**.

### With Secret (Production)

1. Set `INVOICE_CRON_SECRET` in Vercel environment variables
2. Vercel cron jobs automatically include the secret in the request
3. The endpoint will verify the secret before processing

**Note**: Vercel automatically adds the secret to cron job requests, so you don't need to configure it manually.

## Monitoring

### Check Cron Job Logs

1. Go to **Vercel Dashboard** → Your Project
2. Navigate to **Deployments**
3. Click on a deployment
4. Go to **Functions** tab
5. Find `/api/invoices/generate-daily`
6. Check **Logs** to see execution history

### Check Invoice Generation

1. Go to your admin dashboard
2. Navigate to **Invoices** section
3. Look for invoices with:
   - `autoGenerated: true`
   - `autoGeneratedForDate: "YYYY-MM-DD"` (today's date)

## Troubleshooting

### Cron Job Not Running

1. **Check Vercel Dashboard** → Settings → Cron Jobs
   - Verify cron job is listed and active
   - Check if there are any errors

2. **Check Deployment**
   - Make sure latest deployment includes `vercel.json`
   - Redeploy if needed

3. **Check Logs**
   - Go to Deployments → Functions → Logs
   - Look for errors or warnings

### Invoices Not Generating

1. **Check API Response**
   - Manually trigger cron job from Vercel Dashboard
   - Check logs for errors

2. **Verify Data**
   - Check if users have shipments for today
   - Verify shipments have valid data

3. **Check Environment Variables**
   - Verify `INVOICE_CRON_SECRET` is set (if using)
   - Check other required env vars

### 405 Error

If you see HTTP 405 error:
- This is normal - the endpoint only accepts POST requests
- Vercel cron automatically sends POST requests
- If testing manually, use POST method (not GET)

## Next Steps

1. ✅ **Deploy to Vercel** (if not already)
2. ✅ **Add `INVOICE_CRON_SECRET`** environment variable
3. ✅ **Verify cron job** appears in Vercel Dashboard
4. ✅ **Test manually** using "Run Now" in Vercel Dashboard
5. ✅ **Monitor** for a few days to ensure it's working

## Summary

- ✅ `vercel.json` is configured
- ⚠️ Add `INVOICE_CRON_SECRET` environment variable in Vercel
- ✅ Deploy to Vercel
- ✅ Verify cron job in Vercel Dashboard
- ✅ Test manually from Vercel Dashboard

The cron job will run automatically every day at 6:00 PM UTC (1:00 PM EST / 2:00 PM EDT).




